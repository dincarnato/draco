#include "graph_cut.hpp"
#include "weighted_clusters.hpp"

#include <algorithm>
#include <armadillo>
#include <cassert>
#include <cmath>
#include <random>
#include <vector>

void test_pairwise_distance() {
  arma::mat a{{1., 2.}, {3., 4.}, {5., 6.}};
  arma::mat b{{8., 12.}, {5., 21.}, {2., 3.}};

  auto distance =
      pairwise_distances(a, b.submat(arma::span::all, arma::span::all));
  arma::mat expected{{std::sqrt(149.), std::sqrt(377.), std::sqrt(2.)},
                     {std::sqrt(89.), std::sqrt(293.), std::sqrt(2.)},
                     {std::sqrt(45.), 15., std::sqrt(18.)}};
  assert(arma::approx_equal(distance, expected, "absdiff", 1e-12));
}

// We only need the second and the third for 3 clusters, this is more than
// enough
arma::mat eigenvectors{
    {
        -1.66823145e-01,
        -1.56522420e-01,
        -2.59060532e-01,
        -2.03707794e-02,
    },
    {
        -2.02312205e-01,
        3.27491678e-01,
        5.06526495e-02,
        1.04794279e-01,
    },
    {
        -2.20337086e-01,
        -1.43717772e-01,
        -1.35486854e-02,
        -4.54839750e-02,
    },
    {
        -1.22373700e-01,
        -1.67984551e-01,
        5.59226704e-02,
        2.26923332e-01,
    },
    {
        -2.28036163e-01,
        -3.35896500e-02,
        7.91171685e-02,
        -4.40239406e-02,
    },
    {
        -1.74699972e-01,
        -2.57981779e-01,
        -1.97157818e-02,
        2.10076073e-01,
    },
    {
        -2.04699775e-01,
        -1.32661754e-01,
        -9.66413151e-02,
        -1.14742131e-01,
    },
    {
        -1.72065555e-01,
        3.45299178e-01,
        3.53742651e-01,
        -6.91070759e-03,
    },
    {
        -1.87068484e-01,
        1.30860968e-01,
        -2.25725880e-01,
        5.25206763e-02,
    },
    {
        -2.11497175e-01,
        -1.78848948e-01,
        -1.02716983e-01,
        -1.62881959e-01,
    },
    {
        -2.13561620e-01,
        6.69879491e-02,
        8.79935695e-02,
        2.59994531e-03,
    },
    {
        -1.57089259e-01,
        -4.17693495e-01,
        8.55214106e-02,
        3.28623498e-02,
    },
    {
        -2.05206762e-01,
        -1.88320389e-01,
        3.97589018e-02,
        -1.16716104e-01,
    },
    {
        -1.82372944e-01,
        -2.28828491e-01,
        -4.92593940e-02,
        -7.55442210e-02,
    },
    {
        -1.49940834e-01,
        8.07393927e-02,
        -1.36386136e-01,
        1.69918845e-01,
    },
    {
        -1.89156517e-01,
        -3.56762662e-02,
        1.81309925e-01,
        3.60084960e-02,
    },
    {
        -2.00136984e-01,
        -1.05672356e-02,
        1.19872677e-01,
        -1.22204100e-01,
    },
    {
        -1.86016378e-01,
        1.97515323e-01,
        -1.47815183e-01,
        1.46860067e-01,
    },
    {
        -1.63991143e-01,
        9.91810591e-02,
        -1.47012115e-02,
        -3.72315417e-01,
    },
    {
        -1.88386386e-01,
        1.12860041e-01,
        -8.94764414e-02,
        1.97177029e-01,
    },
    {
        -2.02587683e-01,
        -1.96437257e-01,
        -1.40283711e-01,
        2.04742399e-02,
    },
    {
        -1.68356139e-01,
        2.19979025e-01,
        -3.96147269e-01,
        7.84422857e-02,
    },
    {
        -2.12435260e-01,
        -1.97811725e-03,
        1.20247178e-01,
        2.78773103e-02,
    },
    {
        -1.82877207e-01,
        1.21648742e-01,
        -2.06413601e-01,
        -1.26839248e-01,
    },
    {
        -1.21059395e-01,
        4.33802347e-02,
        3.30615622e-01,
        -5.21888382e-01,
    },
    {
        -1.47300281e-01,
        4.68626999e-02,
        4.18115388e-03,
        3.19384727e-01,
    },
    {
        -2.02871068e-01,
        -3.24616563e-02,
        9.68114643e-02,
        -2.82990535e-02,
    },
    {
        -1.11230261e-01,
        2.93885947e-01,
        -2.57540440e-01,
        -2.90280639e-01,
    },
    {
        -1.91002739e-01,
        1.80261829e-01,
        1.94467374e-01,
        1.14607314e-01,
    },
    {
        -1.36682369e-01,
        6.08555304e-02,
        3.91008420e-01,
        2.93040548e-01,
    },
};

void test_eigenvectors_to_weighted_clusters_2_clusters() {
  std::mt19937 random_generator(42);
  auto weights =
      eigenvectors_to_weighted_clusters(eigenvectors, 2, 10, random_generator);
  arma::mat expected_weights{
      {0.34229827, 0.97666098, 0.35908041, 0.32727568, 0.50341748, 0.20932274,
       0.37357074, 1.,         0.71895115, 0.31303649, 0.63523735, 0.,
       0.30062295, 0.24753187, 0.65326039, 0.5006827,  0.53359131, 0.80631026,
       0.67743056, 0.69535863, 0.28998475, 0.83575183, 0.54484845, 0.70687735,
       0.60429641, 0.60886062, 0.50489586, 0.93261635, 0.78369733, 0.62720003},
      {0.65770173, 0.02333902, 0.64091959, 0.67272432, 0.49658252, 0.79067726,
       0.62642926, 0.,         0.28104885, 0.68696351, 0.36476265, 1.,
       0.69937705, 0.75246813, 0.34673961, 0.4993173,  0.46640869, 0.19368974,
       0.32256944, 0.30464137, 0.71001525, 0.16424817, 0.45515155, 0.29312265,
       0.39570359, 0.39113938, 0.49510414, 0.06738365, 0.21630267, 0.37279997}};
  assert(arma::approx_equal(weights, expected_weights, "absdiff", 1e-6));
}

void test_eigenvectors_to_weighted_clusters_2_clusters_zero_eigenvec() {
  std::mt19937 random_generator(42);
  auto weights = eigenvectors_to_weighted_clusters(arma::mat(30, 2), 2, 10,
                                                   random_generator);
  assert(weights.n_cols == 30);
  assert(weights.n_rows == 2);
  assert(std::ranges::all_of(weights, [](auto value) { return value == 0.5; }));
}

void test_eigenvectors_to_weighted_clusters_3_clusters() {
  std::mt19937 random_generator(42);
  auto weights =
      eigenvectors_to_weighted_clusters(eigenvectors, 3, 10, random_generator);
  arma::mat expected_weights{
      {0.3033031,  0.50990163, 0.136052,   0.14830212, 0.1535167,  0.13647011,
       0.20016071, 0.29073715, 0.63613323, 0.17788962, 0.25500316, 0.14483115,
       0.1450169,  0.13552828, 0.63842935, 0.14969429, 0.1475925,  0.70994543,
       0.6074812,  0.70855057, 0.19811593, 0.63142584, 0.14642301, 0.63793721,
       0.14824903, 0.53191788, 0.15219814, 0.70336051, 0.28295683, 0.15014922},
      {0.52770481, 0.15536629, 0.68455873, 0.56708909, 0.27612255, 0.68061838,
       0.63964028, 0.15946626, 0.20709104, 0.66464211, 0.15789343, 0.6051023,
       0.60322441, 0.70431948, 0.20506831, 0.21903081, 0.19390574, 0.13914607,
       0.14663065, 0.14163002, 0.64192704, 0.21124436, 0.17885651, 0.20550169,
       0.15580069, 0.1537528,  0.25345237, 0.14741885, 0.15918187, 0.15397126},
      {0.1689921,  0.33473209, 0.17938927, 0.28460879, 0.57036075, 0.18291152,
       0.16019901, 0.54979659, 0.15677573, 0.15746827, 0.58710341, 0.25006655,
       0.25175869, 0.16015224, 0.15650234, 0.6312749,  0.65850177, 0.1509085,
       0.24588815, 0.14981941, 0.15995703, 0.1573298,  0.67472048, 0.1565611,
       0.69595028, 0.31432932, 0.59434949, 0.14922064, 0.5578613,  0.69587951},
  };
  assert(arma::approx_equal(weights, expected_weights, "absdiff", 1e-6));
}

void test_merge_weighted_clusters() {
  std::vector all_weighted_clusters{
      WeightedClusters{
          {0.1f, 0.2f, 0.3f, 0.4f, 0.5f},
          {0.6f, 0.3f, 0.6f, 0.2f, 0.3f},
          {0.3f, 0.5f, 0.1f, 0.4f, 0.2f},
      },
      WeightedClusters{
          {0.1f, 0.2f, 0.2f, 0.4f, 0.4f},
          {0.5f, 0.3f, 0.6f, 0.2f, 0.4f},
          {0.4f, 0.5f, 0.2f, 0.4f, 0.2f},
      },
      WeightedClusters{
          {0.2f, 0.2f, 0.3f, 0.4f, 0.5f},
          {0.6f, 0.3f, 0.6f, 0.3f, 0.3f},
          {0.2f, 0.5f, 0.1f, 0.3f, 0.2f},
      },
  };

  auto merged_weighted_clusters =
      merge_weighted_clusters(std::move(all_weighted_clusters));
  WeightedClusters expected_weighted_clusters{
      {0.4f / 3.f, 0.2f, 0.8f / 3.f, 0.4f, 1.4f / 3.f},
      {1.7f / 3.f, 0.3f, 0.6f, 0.7f / 3.f, 1.f / 3.f},
      {0.3f, 0.5f, 0.4f / 3.f, 1.1f / 3.f, 0.2f},
  };
  assert(std::ranges::equal(
      merged_weighted_clusters, expected_weighted_clusters,
      [](auto &&merged_base_weights, auto &&expected_base_weights) {
        return std::ranges::equal(merged_base_weights, expected_base_weights);
      }));
}

int main() {
  test_pairwise_distance();
  test_eigenvectors_to_weighted_clusters_2_clusters();
  test_eigenvectors_to_weighted_clusters_2_clusters_zero_eigenvec();
  test_eigenvectors_to_weighted_clusters_3_clusters();
  test_merge_weighted_clusters();
}
